name: C hello CI/CD Pipeline

on:
  # 手动触发配置
  workflow_dispatch:
    inputs:
      release_type:
        description: '发布类型'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      environment:
        description: '部署环境'
        required: true
        default: 'staging'
        type: choice
        options:
          - development
          - staging
          - production
  
  # 自动触发配置
  push:
    branches: [ main, develop ]
    tags: [ "v*" ]
  pull_request:
    branches: [ main ]

jobs:
  # 构建和测试阶段
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler: [gcc, clang]
        platform: [ubuntu-latest]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup C Compiler
        run: |
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            sudo apt-get update
            sudo apt-get install -y gcc gdb
          else
            sudo apt-get update
            sudo apt-get install -y clang
          fi
      
      - name: Build project
        run: |
          echo "使用编译器: ${{ matrix.compiler }}"
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            CC=gcc make all
          else
            CC=clang make all
          fi
      
      - name: Run tests
        run: make test
      
      - name: Static analysis
        run: |
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            gcc -Wall -Wextra -pedantic -c src/hello.c -I./include -o /dev/null
          else
            clang --analyze src/hello.c
          fi
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: hello-${{ matrix.compiler }}
          path: |
            hello
            src/*.c
            include/*.h
          retention-days: 7

  # 跨平台编译测试[6](@ref)[8](@ref)
  cross-platform-build:
    needs: build-and-test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        architecture: [x86_64, i686, arm, aarch64]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup cross-compilation tools
        run: |
          sudo apt-get update
          case "${{ matrix.architecture }}" in
            i686)
              sudo apt-get install -y gcc-multilib
              export CC="gcc -m32"
              ;;
            arm)
              sudo apt-get install -y gcc-arm-linux-gnueabi qemu-user
              export CC="arm-linux-gnueabi-gcc"
              ;;
            aarch64)
              sudo apt-get install -y gcc-aarch64-linux-gnu qemu-user
              export CC="aarch64-linux-gnu-gcc"
              ;;
            *)
              export CC="gcc"
              ;;
          esac
      
      - name: Cross-compile
        run: |
          CC="$CC" make clean
          CC="$CC" make all
          file hello
      
      - name: Test with QEMU (for ARM)
        if: ${{ matrix.architecture == 'arm' || matrix.architecture == 'aarch64' }}
        run: |
          if [ "${{ matrix.architecture }}" = "arm" ]; then
            qemu-arm -L /usr/arm-linux-gnueabi ./hello
          else
            qemu-aarch64 -L /usr/aarch64-linux-gnu ./hello
          fi

  # 发布阶段
  create-release:
    needs: [build-and-test, cross-platform-build]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get version
        id: get_version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            # 手动触发时生成版本号
            DATE=$(date +'%Y%m%d')
            COMMIT_SHORT=$(git rev-parse --short HEAD)
            VERSION="1.0.0-$DATE-$COMMIT_SHORT"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG_NAME=v$VERSION" >> $GITHUB_OUTPUT
      
      - name: Build release binaries
        run: |
          # 构建不同优化级别的版本[6](@ref)
          make clean
          make all
          cp hello hello-standard
          
          # 构建优化版本
          CFLAGS="-Wall -Wextra -O3 -flto" make clean all
          cp hello hello-optimized
          
          # 构建调试版本
          CFLAGS="-Wall -Wextra -g -DDEBUG" make clean all
          cp hello hello-debug
      
      - name: Create package
        run: |
          mkdir -p hello-${{ steps.get_version.outputs.VERSION }}
          cp hello-standard hello-${{ steps.get_version.outputs.VERSION }}/
          cp hello-optimized hello-${{ steps.get_version.outputs.VERSION }}/
          cp hello-debug hello-${{ steps.get_version.outputs.VERSION }}/
          cp src/hello.c hello-${{ steps.get_version.outputs.VERSION }}/
          cp include/hello.h hello-${{ steps.get_version.outputs.VERSION }}/
          cp Makefile hello-${{ steps.get_version.outputs.VERSION }}/
          cp README.md hello-${{ steps.get_version.outputs.VERSION }}/
          
          # 创建压缩包
          tar -czf hello-${{ steps.get_version.outputs.VERSION }}.tar.gz hello-${{ steps.get_version.outputs.VERSION }}
          zip -r hello-${{ steps.get_version.outputs.VERSION }}.zip hello-${{ steps.get_version.outputs.VERSION }}
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: ${{ steps.get_version.outputs.TAG_NAME }}
          name: "hello v${{ steps.get_version.outputs.VERSION }}"
          draft: false
          prerelease: ${{ github.event.inputs.environment != 'production' && github.event_name == 'workflow_dispatch' }}
          generate_release_notes: true
          files: |
            hello-${{ steps.get_version.outputs.VERSION }}.tar.gz
            hello-${{ steps.get_version.outputs.VERSION }}.zip
            hello-standard
            hello-optimized
            hello-debug
      
      - name: Upload to release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-v${{ steps.get_version.outputs.VERSION }}
          path: |
            hello-${{ steps.get_version.outputs.VERSION }}.tar.gz
            hello-${{ steps.get_version.outputs.VERSION }}.zip
          retention-days: 30

